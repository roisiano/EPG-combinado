name: EPG Workflow

on:
  schedule:
    - cron: '57 8 * * *'  # Ejecuta a las 08:57 UTC cada d√≠a
  workflow_dispatch:  # Permite ejecutar manualmente el flujo de trabajo

jobs:
  epg:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests lxml

      - name: Download EPG and process
        run: |
          # Crear directorio de trabajo
          mkdir -p /tmp/epg

          # Descargar archivo XML
          curl -L -o /tmp/epg/epg.xml.gz https://github.com/davidmuma/EPG_dobleM/raw/master/guiatv_color.xml.gz

          # Descomprimir el archivo
          gunzip -f /tmp/epg/epg.xml.gz

          # Copiar el script Python desde el repositorio al directorio de trabajo
          cp .github/workflows/process_epg.py /tmp/epg/process_epg.py

          # Ejecutar el script de procesamiento de EPG
          python3 /tmp/epg/process_epg.py

      - name: Commit and push updated EPGcompleto.xml
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"

          # Reemplazar el archivo EPGcompleto.xml en el repositorio
          cp /tmp/epg/EPGcompleto.xml ./EPGcompleto.xml
          git add EPGcompleto.xml
          git commit -m "Update EPGcompleto.xml"
          git push origin main
