name: EPG Workflow

on:
  schedule:
    - cron: '57 8 * * *'  # Ejecuta a las 08:57 UTC cada dÃ­a
  workflow_dispatch:  # Permite ejecutar manualmente el flujo de trabajo

jobs:
  epg:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests lxml

      - name: Download EPG and process
        run: |
          # Crear directorio de trabajo
          mkdir -p /tmp/epg

          # Descargar archivo XML
          curl -L -o /tmp/epg/epg.xml.gz https://github.com/davidmuma/EPG_dobleM/raw/master/guiatv_color.xml.gz

          # Descomprimir el archivo
          gunzip -f /tmp/epg/epg.xml.gz

          # Copiar el script Python desde el repositorio al directorio de trabajo
          cp .github/workflows/process_epg.py /tmp/epg/process_epg.py

          # Ejecutar el script de procesamiento de EPG
          python3 /tmp/epg/process_epg.py

      - name: Prepare JSON for GitHub API
        run: |
          # Crear archivo JSON para la API de GitHub
          FILE_PATH="/tmp/epg/EPGcompleto.xml"
          REPO="roisiano/EPG-combinado"
          FILE_NAME="EPGcompleto.xml"
          BRANCH="main"

          if curl -s -H "Authorization: token ${{ secrets.TKN1 }}" "https://api.github.com/repos/$REPO/contents/$FILE_NAME?ref=$BRANCH" | jq -e '.sha' > /dev/null 2>&1; then
            SHA=$(curl -s -H "Authorization: token ${{ secrets.TKN1 }}" "https://api.github.com/repos/$REPO/contents/$FILE_NAME?ref=$BRANCH" | jq -r '.sha')

            echo "{\"message\": \"Actualizar archivo $FILE_NAME\", \"content\": \"$(base64 -w 0 $FILE_PATH)\", \"sha\": \"$SHA\", \"branch\": \"$BRANCH\"}" > /tmp/commit_data.json
          else
            echo "{\"message\": \"Crear archivo $FILE_NAME\", \"content\": \"$(base64 -w 0 $FILE_PATH)\", \"branch\": \"$BRANCH\"}" > /tmp/commit_data.json
          fi

      - name: Upload EPGcompleto.xml to GitHub
        env:
          GITHUB_TOKEN: ${{ secrets.TKN1 }}
        run: |
          FILE_PATH="/tmp/epg/EPGcompleto.xml"
          REPO="roisiano/EPG-combinado"
          FILE_NAME="EPGcompleto.xml"
          BRANCH="main"

          # Enviar archivo a GitHub usando la API
          curl -s -X PUT -H "Authorization: token $GITHUB_TOKEN" \
            -H "Content-Type: application/vnd.github.v3+json" \
            --data-binary @"./tmp/commit_data.json" \
            "https://api.github.com/repos/$REPO/contents/$FILE_NAME"
